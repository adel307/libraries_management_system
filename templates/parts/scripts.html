{% load static %}
<!-- jQuery from CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap from CDN -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- AdminLTE from CDN -->
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

<!-- Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function(){
    // Initialize modal functionality
    $('#myModal').on('shown.bs.modal', function () {
        $('#myInput').trigger('focus');
    });

    // Initialize charts only if they exist on the page
    initializeCharts();
});

function initializeCharts() {
    // Sales Chart - only initialize if element exists
    var $salesChart = $('#sales-chart');
    if ($salesChart.length > 0) {
        try {
            var salesChart = new Chart($salesChart, {
                type: 'bar',
                data: {
                    labels: ['تفاصيل الارباح'],
                    datasets: [
                        {
                            label: 'المبيعات',
                            backgroundColor: '#007bff',
                            borderColor: '#007bff',
                            data: [50]
                        },
                        {
                            label: 'التكاليف',
                            backgroundColor: '#ced4da',
                            borderColor: '#ced4da',
                            data: [30]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.log('Sales chart initialization skipped:', error);
        }
    }

    // Pie Chart - only initialize if element exists
    var $visitorsChart = $('#visitors-chart');
    if ($visitorsChart.length > 0) {
        try {
            var pieChart = new Chart($visitorsChart, {
                type: 'pie',
                data: {
                    datasets: [{
                        data: [35, 25, 40],
                        backgroundColor: ["#27c100", "#f3545d", "#fdaf4b"],
                        borderWidth: 2
                    }],
                    labels: ['متاح', 'مباع', 'مستعار']
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.log('Pie chart initialization skipped:', error);
        }
    }
}

// Utility functions for library management
function deleteBook(bookId) {
    if (confirm('هل أنت متأكد من حذف هذا الكتاب؟')) {
        // AJAX call to delete book
        $.ajax({
            url: '/books/delete/' + bookId + '/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                if (response.success) {
                    alert('تم حذف الكتاب بنجاح');
                    location.reload();
                } else {
                    alert('حدث خطأ أثناء حذف الكتاب');
                }
            },
            error: function() {
                alert('حدث خطأ أثناء حذف الكتاب');
            }
        });
    }
}

function renewBook(bookId) {
    if (confirm('هل تريد تجديد استعارة هذا الكتاب؟')) {
        // AJAX call to renew book
        $.ajax({
            url: '/books/renew/' + bookId + '/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                if (response.success) {
                    alert('تم تجديد الكتاب بنجاح');
                    location.reload();
                } else {
                    alert('حدث خطأ أثناء تجديد الكتاب');
                }
            },
            error: function() {
                alert('حدث خطأ أثناء تجديد الكتاب');
            }
        });
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Search functionality
function searchBooks() {
    var searchTerm = $('#searchInput').val().toLowerCase();
    $('.book-card').each(function() {
        var bookTitle = $(this).find('.book-title').text().toLowerCase();
        var bookAuthor = $(this).find('.book-author').text().toLowerCase();
        
        if (bookTitle.includes(searchTerm) || bookAuthor.includes(searchTerm) || searchTerm === '') {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

// Initialize tooltips
$(function () {
    $('[data-toggle="tooltip"]').tooltip();
});
</script>